name: Create Release

on:
  workflow_dispatch:

jobs:
  tag-release:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.extract.outputs.tag }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git Credentials
        run: |
          git config user.name github-actions[bot]
          git config user.email 41898282+github-actions[bot]@users.noreply.github.com

      - name: Extract version from pyproject.toml
        id: extract
        run: |
          VERSION=$(grep -E '^version =' pyproject.toml | sed -E 's/version = "(.*)"/\1/')
          if [ -z "$VERSION" ]; then
            echo "No version found in pyproject.toml" >&2
            exit 1
          fi
          TAG="v$VERSION"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      - name: Create tag
        run: |
          git tag "${{ steps.extract.outputs.tag }}"
          git push origin "${{ steps.extract.outputs.tag }}"

  build:
    needs: tag-release
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu

          - os: macos-latest
            target: x86_64-apple-darwin
          - os: macos-latest
            target: aarch64-apple-darwin

    steps:
      - name: Checkout
        uses: actions/checkout@v4
    
      - name: Project setup
        uses: ./.github/actions/project-setup

      - name: Build Encoderfile CLI
        run: cargo build --bin encoderfile --target ${{ matrix.target }}

      - name: Package tarball for Encoderfile CLI
        run: |
          BIN="encoderfile"
          TARGET="${{ matrix.target }}"
          OUT_DIR="dist"
          mkdir -p "$OUT_DIR"

          BIN_NAME="${BIN}-${TARGET}"
          cp "target/${TARGET}/release/${BIN}" "${BIN_NAME}"

          TAR_NAME="${BIN}-${TARGET}.tar.gz"

          tar -czf "$OUT_DIR/$TAR_NAME" \
            "${BIN_NAME}" \
            README.md \
            LICENSE \
            THIRDPARTY.md

          echo "ENCODERFILE_CLI_TARBALL=$OUT_DIR/$TAR_NAME" >> $GITHUB_ENV

      - name: Upload tarball artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ENCODERFILE_CLI_TARBALL }}
          path: ${{ env.ENCODERFILE_CLI_TARBALL }}

  publish-release:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.tag-release.outputs.tag }}
          name: ${{ needs.tag-release.outputs.tag }}
          files: dist/**
