name: release

on:
  pull_request:
    types: [closed]
    branches: [main]

  workflow_dispatch:
    inputs:
      dry_run:
        description: Publish artifacts
        required: true
        type: choice
        options: ["true", "false"]

permissions:
  contents: write
  packages: write
  id-token: write

env:
  IS_DRY_RUN: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run == 'true' }}

jobs:
  create-tag:
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    runs-on: ubuntu-latest

    outputs:
      version: ${{ steps.version.outputs.VERSION }}
      prerelease: ${{ steps.version.outputs.PRERELEASE }}

    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Determine version
        id: version
        run: |
          set -euo pipefail

          # Extract version from Cargo metadata
          VERSION=$(
            cargo metadata --no-deps --format-version=1 \
              | jq -r '.packages[]
                | select(.name == "encoderfile")
                | .version'
          )

          if [ -z "$VERSION" ] || [ "$VERSION" = "null" ]; then
            echo "encoderfile package not found in cargo metadata"
            exit 1
          fi

          # Determine prerelease (PRs only)
          PRE="false"
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            if [[ "${{ contains(github.event.pull_request.labels.*.name, 'alpha') }}" == "true" ]] || \
              [[ "${{ contains(github.event.pull_request.labels.*.name, 'beta') }}" == "true" ]] || \
              [[ "${{ contains(github.event.pull_request.labels.*.name, 'rc') }}" == "true" ]]; then
              PRE="true"
            fi
          fi

          echo "VERSION=$VERSION" >> "$GITHUB_OUTPUT"
          echo "PRERELEASE=$PRE" >> "$GITHUB_OUTPUT"


      - name: Create git tag
        if: env.IS_DRY_RUN != 'true'
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          git tag -a "v$VERSION" -m "Version $VERSION" || true
          git push origin "v$VERSION" || true

      - name: Dry-run tag
        if: env.IS_DRY_RUN == 'true'
        run: echo "[DRY RUN] would create tag v${{ steps.version.outputs.VERSION }}"

  build-macos:
    needs: create-tag
    runs-on: macos-14
    strategy:
      matrix:
        target:
          - x86_64-apple-darwin
          - aarch64-apple-darwin

    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/project-setup

      - run: rustup target add ${{ matrix.target }}

      - name: Build
        run: |
          cargo build --release --target ${{ matrix.target }}
          mkdir -p dist
          cp target/${{ matrix.target }}/release/encoderfile dist/
          cp target/${{ matrix.target }}/release/encoderfile-runtime dist/

      - name: Package
        run: |
          mkdir pkg
          cp dist/* README.md LICENSE pkg/
          test -f THIRDPARTY.md && cp THIRDPARTY.md pkg/
          tar -czf encoderfile-${{ matrix.target }}.tar.gz -C pkg .
          tar -czf encoderfile-runtime-${{ matrix.target }}.tar.gz -C pkg .

      - uses: actions/upload-artifact@v4
        if: env.IS_DRY_RUN != 'true'
        with:
          name: macos-${{ matrix.target }}
          path: "*.tar.gz"

  build-linux:
    needs: create-tag
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            platform: linux/amd64
            runner: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - arch: arm64
            platform: linux/arm64
            runner: ubuntu-24.04-arm
            target: aarch64-unknown-linux-gnu

    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build (bookworm, ${{ matrix.arch }})
        run: |
          docker buildx build \
            --platform ${{ matrix.platform }} \
            -f Dockerfile \
            --target build \
            --load \
            -t encoderfile-build:${{ matrix.arch }} \
            .

          CID=$(docker create encoderfile-build:${{ matrix.arch }})
          mkdir -p dist
          docker cp "$CID:/app/target/release/encoderfile" dist/
          docker cp "$CID:/app/target/release/encoderfile-runtime" dist/
          docker rm "$CID"

      - name: Package
        run: |
          mkdir pkg
          cp dist/* README.md LICENSE pkg/
          test -f THIRDPARTY.md && cp THIRDPARTY.md pkg/

          tar -czf encoderfile-${{ matrix.target }}.tar.gz -C pkg .
          tar -czf encoderfile-runtime-${{ matrix.target }}.tar.gz -C pkg .

      - uses: actions/upload-artifact@v4
        if: env.IS_DRY_RUN != 'true'
        with:
          name: linux-${{ matrix.arch }}
          path: "*.tar.gz"

  release:
    needs: [create-tag, build-macos, build-linux]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/download-artifact@v4
        with:
          path: dist

      - uses: softprops/action-gh-release@v2
        if: env.IS_DRY_RUN != 'true'
        with:
          tag_name: v${{ needs.create-tag.outputs.version }}
          name: v${{ needs.create-tag.outputs.version }}
          prerelease: ${{ needs.create-tag.outputs.prerelease }}
          files: dist/**/*.tar.gz
          generate_release_notes: true

  docker-build:
    needs: [release, create-tag]
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            platform: linux/amd64
            runner: ubuntu-latest
          - arch: arm64
            platform: linux/arm64
            runner: ubuntu-24.04-arm

    steps:
      - uses: actions/checkout@v4

      - uses: docker/login-action@v3
        if: env.IS_DRY_RUN != 'true'
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ github.token }}

      - name: Build image
        run: |
          docker build \
            --platform ${{ matrix.platform }} \
            -t ghcr.io/${{ github.repository_owner }}/encoderfile:${{ matrix.arch }}-${{ needs.create-tag.outputs.version }} \
            .

      - name: Push image
        if: env.IS_DRY_RUN != 'true'
        run: |
          docker push \
            ghcr.io/${{ github.repository_owner }}/encoderfile:${{ matrix.arch }}-${{ needs.create-tag.outputs.version }}

  docker-manifest:
    needs: [docker-build, create-tag]

    runs-on: ubuntu-latest

    steps:
      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ github.token }}

      - name: Bundle dockerfiles
        if: env.IS_DRY_RUN != 'true'
        run: |
          VERSION=${{ needs.create-tag.outputs.version }}
          PRE=${{ needs.create-tag.outputs.prerelease }}

          if [[ "$PRE" == "true" ]]; then
            docker buildx imagetools create \
              -t ghcr.io/${{ github.repository_owner }}/encoderfile:${VERSION} \
              ghcr.io/${{ github.repository_owner }}/encoderfile:amd64-${VERSION} \
              ghcr.io/${{ github.repository_owner }}/encoderfile:arm64-${VERSION}
          else
            docker buildx imagetools create \
              -t ghcr.io/${{ github.repository_owner }}/encoderfile:${VERSION} \
              -t ghcr.io/${{ github.repository_owner }}/encoderfile:latest \
              ghcr.io/${{ github.repository_owner }}/encoderfile:amd64-${VERSION} \
              ghcr.io/${{ github.repository_owner }}/encoderfile:arm64-${VERSION}
          fi

  publish-encoderfile:
    needs: release
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/project-setup

      - name: Cargo publish (dry-run)
        run: cargo publish -p encoderfile --dry-run

      - name: Cargo publish
        if: env.IS_DRY_RUN != 'true'
        run: cargo publish -p encoderfile
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
